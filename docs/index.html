<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakNode â€” Knowledge Graph Demo</title>
    <meta name="description" content="Local-first AI meeting knowledge extraction and graph visualization demo">
    <style>
        * { box-sizing: border-box; }
        body { margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:#0f0f0f; color:#fff; overflow:hidden; }
        .main-container { display:flex; height:100vh; flex-direction:column; }

        /* Header */
        .header { background:#000; padding:10px 24px; border-bottom:1px solid rgba(255,255,255,0.06); flex-shrink:0; display:flex; align-items:center; justify-content:space-between; }
        .header h1 { margin:0; font-size:1.4em; font-weight:600; color:#fff; display:flex; align-items:center; gap:8px; }
        .header h1 .accent { color:#60a5fa; }
        .header-links a { color:#60a5fa; text-decoration:none; font-size:0.85em; padding:4px 10px; border:1px solid rgba(96,165,250,0.4); border-radius:4px; transition:all .2s; }
        .header-links a:hover { background:#60a5fa; color:#fff; }

        /* Content */
        .content-container { display:flex; flex:1; min-height:0; }

        /* Left Panel */
        .left-panel { width:300px; background:rgba(0,0,0,0.6); border-right:1px solid rgba(255,255,255,0.06); padding:16px; overflow-y:auto; flex-shrink:0; }
        .left-panel h2 { margin:0 0 12px; font-size:1.1em; color:#fff; border-bottom:2px solid #60a5fa; padding-bottom:6px; }
        .section-title { font-size:0.8em; font-weight:600; color:#9ca3af; text-transform:uppercase; letter-spacing:0.5px; margin:16px 0 8px; }

        /* Demo Cards */
        .demo-card { padding:10px 12px; margin:6px 0; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:6px; cursor:pointer; transition:all .2s; }
        .demo-card:hover { background:rgba(96,165,250,0.1); border-color:rgba(96,165,250,0.3); }
        .demo-card.active { background:rgba(96,165,250,0.15); border-color:#60a5fa; }
        .demo-card .dc-icon { font-size:1.2em; margin-right:6px; }
        .demo-card .dc-title { font-size:0.9em; font-weight:600; color:#e5e7eb; }
        .demo-card .dc-desc { font-size:0.75em; color:#9ca3af; margin-top:4px; line-height:1.3; }

        /* Demo Image Cards */
        .demo-img-card { position:relative; margin:8px 0; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); cursor:pointer; transition:all .25s; }
        .demo-img-card:hover { border-color:rgba(96,165,250,0.5); transform:translateY(-1px); box-shadow:0 4px 12px rgba(96,165,250,0.15); }
        .demo-img-card.active { border-color:#60a5fa; box-shadow:0 0 0 1px #60a5fa; }
        .demo-img-card img { width:100%; display:block; }
        .demo-img-card .card-overlay { position:absolute; bottom:0; left:0; right:0; padding:6px 10px; background:linear-gradient(transparent, rgba(0,0,0,0.85)); display:flex; align-items:center; justify-content:space-between; }
        .demo-img-card .card-overlay .card-label { font-size:0.78em; font-weight:600; color:#e5e7eb; }
        .demo-img-card .card-dl-btn { background:rgba(96,165,250,0.2); border:1px solid rgba(96,165,250,0.4); color:#60a5fa; border-radius:4px; padding:3px 8px; font-size:0.7em; cursor:pointer; transition:all .2s; display:flex; align-items:center; gap:3px; }
        .demo-img-card .card-dl-btn:hover { background:#60a5fa; color:#fff; }
        .demo-img-card .card-loading { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,15,15,0.9); color:#4b5563; font-size:0.8em; }

        /* Drop Zone */
        .drop-zone { margin:8px 0; padding:20px 12px; border:2px dashed rgba(255,255,255,0.15); border-radius:8px; text-align:center; cursor:pointer; transition:all .2s; }
        .drop-zone:hover, .drop-zone.dragover { border-color:#60a5fa; background:rgba(96,165,250,0.08); }
        .drop-zone p { margin:4px 0; font-size:0.8em; color:#9ca3af; }
        .drop-zone .dz-icon { font-size:1.6em; margin-bottom:4px; }
        .drop-zone input[type=file] { display:none; }

        /* Collapsible details */
        details { margin:4px 0; }
        details summary { cursor:pointer; font-size:0.8em; font-weight:600; color:#9ca3af; padding:6px 0; list-style:none; display:flex; align-items:center; gap:4px; }
        details summary::before { content:'â–¸'; font-size:0.7em; transition:transform .2s; }
        details[open] summary::before { transform:rotate(90deg); }
        .mini-step { padding:6px 10px; margin:3px 0; background:rgba(96,165,250,0.05); border-radius:4px; border-left:2px solid #60a5fa; font-size:0.75em; color:#d1d5db; line-height:1.4; }
        .mini-step.purple { background:rgba(168,85,247,0.05); border-color:#a855f7; }
        .mini-step.green { background:rgba(34,197,94,0.05); border-color:#22c55e; }
        .mini-step b { color:#fff; }

        /* Center Panel */
        .center-panel { flex:1; position:relative; background:#0a0a0a; }
        .center-panel #graph-canvas { width:100%; height:100%; }
        .graph-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#4b5563; pointer-events:none; }
        .graph-placeholder .ph-icon { font-size:3em; margin-bottom:12px; }
        .graph-placeholder p { font-size:0.9em; }

        /* Right Panel */
        .right-panel { width:320px; background:rgba(0,0,0,0.6); border-left:1px solid rgba(255,255,255,0.06); padding:16px; overflow-y:auto; flex-shrink:0; }
        .right-panel h2 { margin:0 0 12px; font-size:1.1em; color:#fff; border-bottom:2px solid #60fae5; padding-bottom:6px; }

        /* Summary Sections */
        .summary-placeholder { text-align:center; padding:40px 12px; color:#4b5563; font-size:0.85em; }
        .summary-section { margin:10px 0; }
        .summary-section h3 { margin:0 0 6px; font-size:0.85em; font-weight:600; display:flex; align-items:center; gap:6px; }
        .summary-item { padding:6px 10px; margin:3px 0; background:rgba(255,255,255,0.04); border-radius:4px; font-size:0.78em; color:#d1d5db; line-height:1.4; border-left:2px solid transparent; }
        .summary-item .si-label { color:#9ca3af; font-size:0.9em; }
        .summary-item.topic { border-color:#22c55e; }
        .summary-item.decision { border-color:#f472b6; }
        .summary-item.task { border-color:#f59e0b; }
        .summary-item.person { border-color:#a855f7; }
        .summary-item.entity { border-color:#ec4899; }
        .task-status { display:inline-block; padding:1px 6px; border-radius:3px; font-size:0.85em; font-weight:600; }
        .task-status.pending { background:rgba(245,158,11,0.15); color:#f59e0b; }
        .task-status.in_progress { background:rgba(6,182,212,0.15); color:#06b6d4; }
        .task-status.done { background:rgba(34,197,94,0.15); color:#22c55e; }
        .task-status.blocked { background:rgba(239,68,68,0.15); color:#ef4444; }

        /* Schema Panel (collapsible) */
        .schema-panel { margin-top:12px; }
        .schema-panel details summary { color:#60fae5; }
        .status-badges { display:flex; gap:6px; flex-wrap:wrap; margin:6px 0; }
        .badge { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:6px; font-size:11px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.04); }
        .badge .dot { width:7px; height:7px; border-radius:99px; }
        .badge.meeting .dot { background:#60a5fa; } .badge.person .dot { background:#a855f7; }
        .badge.topic .dot { background:#22c55e; } .badge.task .dot { background:#f59e0b; }
        .badge.decision .dot { background:#f472b6; } .badge.utterance .dot { background:#06b6d4; }
        .badge.entity .dot { background:#ec4899; }
        .details-grid { display:grid; grid-template-columns:1fr 1fr; gap:3px 8px; font-size:11px; color:#9ca3af; margin:6px 0; }

        /* Node Detail */
        .node-detail-card { background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.08); border-radius:6px; padding:10px; margin-top:8px; display:none; }
        .node-detail-card.visible { display:block; }
        .node-detail-card h4 { margin:0 0 6px; font-size:0.9em; }
        .node-detail-card .field { display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.78em; }
        .node-detail-card .field-label { color:#6b7280; }

        /* Utterance Toggle */
        .utt-toggle { display:flex; align-items:center; gap:6px; margin:6px 0; font-size:0.75em; color:#9ca3af; }
        .utt-toggle input { accent-color:#06b6d4; }

        /* Status Bar */
        .status-bar { background:#000; color:#4b5563; padding:6px 16px; font-family:'Courier New',monospace; font-size:0.75em; border-top:1px solid rgba(255,255,255,0.04); flex-shrink:0; }

        @media (max-width:1100px) { .left-panel{width:260px;} .right-panel{width:280px;} }
        @media (max-width:768px) { .content-container{flex-direction:column;} .left-panel,.right-panel{width:100%;max-height:180px;} .center-panel{min-height:350px;} }
    </style>
</head>

<body>
<div class="main-container">
    <!-- Header -->
    <header class="header">
        <h1><span class="accent">SpeakNode</span> Knowledge Graph <span style="font-size:0.5em;color:#9ca3af;font-weight:400;margin-left:6px;">â€” User Demo</span></h1>
        <div class="header-links">
            <a href="https://github.com/Kinder1203/SpeakNode" target="_blank">GitHub</a>
        </div>
    </header>

    <div class="content-container">
        <!-- Left Panel -->
        <div class="left-panel">
            <h2>Try Demo</h2>
            <p style="font-size:0.78em;color:#9ca3af;margin:0 0 10px;">Example PNGë¥¼ ì„ íƒí•˜ê±°ë‚˜ SpeakNode PNGë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>

            <div class="demo-img-card" id="dc0" onclick="loadDemo(0)">
                <img src="docs/demo_weekly_meeting.png" alt="ì£¼ê°„ ê¸°íš íšŒì˜">
                <div class="card-overlay">
                    <span class="card-label">ğŸ“… ì£¼ê°„ ê¸°íš íšŒì˜</span>
                    <a class="card-dl-btn" href="demos/demo_weekly_meeting.png" download="speaknode_ì£¼ê°„ê¸°íšíšŒì˜.png" onclick="event.stopPropagation()" title="PNG ë‹¤ìš´ë¡œë“œ">â¬‡ PNG</a>
                </div>
            </div>
            <div class="demo-img-card" id="dc1" onclick="loadDemo(1)">
                <img src="docs/demo_ai_seminar.png" alt="AI ê¸°ìˆ  ì„¸ë¯¸ë‚˜">
                <div class="card-overlay">
                    <span class="card-label">ğŸ“ AI ê¸°ìˆ  ì„¸ë¯¸ë‚˜</span>
                    <a class="card-dl-btn" href="demos/demo_ai_seminar.png" download="speaknode_AIê¸°ìˆ ì„¸ë¯¸ë‚˜.png" onclick="event.stopPropagation()" title="PNG ë‹¤ìš´ë¡œë“œ">â¬‡ PNG</a>
                </div>
            </div>
            <div class="demo-img-card" id="dc2" onclick="loadDemo(2)">
                <img src="docss/demo_project_onboarding.png" alt="í”„ë¡œì íŠ¸ ì˜¨ë³´ë”©">
                <div class="card-overlay">
                    <span class="card-label">ğŸš€ í”„ë¡œì íŠ¸ ì˜¨ë³´ë”©</span>
                    <a class="card-dl-btn" href="demos/demo_project_onboarding.png" download="speaknode_í”„ë¡œì íŠ¸ì˜¨ë³´ë”©.png" onclick="event.stopPropagation()" title="PNG ë‹¤ìš´ë¡œë“œ">â¬‡ PNG</a>
                </div>
            </div>

            <div class="section-title">Upload PNG</div>
            <div class="drop-zone" id="dropZone">
                <div class="dz-icon">ğŸ“</div>
                <p><b>SpeakNode PNG</b>ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                <p style="font-size:0.7em;color:#6b7280;">PNG ë©”íƒ€ë°ì´í„°ì—ì„œ ê·¸ë˜í”„ë¥¼ ìë™ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
                <input type="file" id="fileInput" accept=".png">
            </div>

            <div class="section-title" style="margin-top:14px;">About</div>
            <details>
                <summary>Pipeline Overview</summary>
                <div class="mini-step"><b>1. Transcribe</b> â€” Faster-Whisper STT + pyannote í™”ì ë¶„ë¦¬</div>
                <div class="mini-step"><b>2. Embed</b> â€” all-MiniLM-L6-v2 ë²¡í„° ì„ë² ë”© (384d)</div>
                <div class="mini-step"><b>3. Extract</b> â€” Ollama + LangChain êµ¬ì¡°í™” ì¶”ì¶œ</div>
                <div class="mini-step"><b>4. Store</b> â€” KuzuDB ê·¸ë˜í”„ DB ì €ì¥</div>
                <div class="mini-step"><b>5. Query</b> â€” Hybrid RAG + LangGraph Agent</div>
                <div class="mini-step"><b>6. Share</b> â€” PNG ë©”íƒ€ë°ì´í„° ê·¸ë˜í”„ ê³µìœ </div>
            </details>
            <details>
                <summary>Graph Controls</summary>
                <div class="mini-step purple"><b>Click</b> â€” ë…¸ë“œ ìƒì„¸ ì •ë³´</div>
                <div class="mini-step purple"><b>Double-click</b> â€” ë…¸ë“œ í¬ì»¤ìŠ¤ ì¤Œ</div>
                <div class="mini-step purple"><b>Drag</b> â€” ë…¸ë“œ/í™”ë©´ ì´ë™</div>
                <div class="mini-step purple"><b>Scroll</b> â€” í™•ëŒ€/ì¶•ì†Œ</div>
            </details>
            <details>
                <summary>Tech Stack</summary>
                <div class="mini-step green"><b>Core:</b> Python 3.10+, KuzuDB, LangGraph</div>
                <div class="mini-step green"><b>LLM:</b> Ollama, LangChain</div>
                <div class="mini-step green"><b>STT:</b> Faster-Whisper, pyannote</div>
                <div class="mini-step green"><b>Client:</b> Kotlin Compose, Ktor</div>
                <div class="mini-step green"><b>API:</b> FastAPI, Uvicorn</div>
            </details>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <div id="graph-canvas"></div>
            <div class="graph-placeholder" id="graphPlaceholder">
                <div class="ph-icon">ğŸ•¸ï¸</div>
                <p>ë°ëª¨ë¥¼ ì„ íƒí•˜ê±°ë‚˜ PNGë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <h2>Summary</h2>
            <div id="summaryContainer">
                <div class="summary-placeholder" id="summaryPlaceholder">
                    <p style="font-size:2em;margin:0;">ğŸ“‹</p>
                    <p>ê·¸ë˜í”„ê°€ ë¡œë“œë˜ë©´ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>

            <label class="utt-toggle" id="uttToggleWrap" style="display:none;">
                <input type="checkbox" id="uttToggle"> Utterance ë…¸ë“œ í‘œì‹œ
            </label>

            <div class="node-detail-card" id="node-detail">
                <h4 id="detail-title">Select a node</h4>
                <div id="detail-fields"></div>
            </div>

            <div class="schema-panel">
                <details>
                    <summary>Graph Schema</summary>
                    <div style="font-size:0.78em;font-weight:600;margin:8px 0 4px;">Node Types</div>
                    <div class="status-badges">
                        <div class="badge meeting"><span class="dot"></span>Meeting</div>
                        <div class="badge person"><span class="dot"></span>Person</div>
                        <div class="badge topic"><span class="dot"></span>Topic</div>
                        <div class="badge task"><span class="dot"></span>Task</div>
                        <div class="badge decision"><span class="dot"></span>Decision</div>
                        <div class="badge utterance"><span class="dot"></span>Utterance</div>
                        <div class="badge entity"><span class="dot"></span>Entity</div>
                    </div>
                    <div style="font-size:0.78em;font-weight:600;margin:10px 0 4px;">Relationships (12)</div>
                    <div class="details-grid">
                        <div>DISCUSSED</div><div style="color:#60a5fa">Meetingâ†’Topic</div>
                        <div>PROPOSED</div><div style="color:#a855f7">Personâ†’Topic</div>
                        <div>ASSIGNED_TO</div><div style="color:#f59e0b">Personâ†’Task</div>
                        <div>RESULTED_IN</div><div style="color:#f472b6">Topicâ†’Decision</div>
                        <div>SPOKE</div><div style="color:#06b6d4">Personâ†’Utterance</div>
                        <div>CONTAINS</div><div style="color:#60a5fa">Meetingâ†’Utterance</div>
                        <div>HAS_TASK</div><div style="color:#f59e0b">Meetingâ†’Task</div>
                        <div>HAS_DECISION</div><div style="color:#f472b6">Meetingâ†’Decision</div>
                        <div>NEXT</div><div style="color:#06b6d4">Utteranceâ†’Utterance</div>
                        <div>RELATED_TO</div><div style="color:#ec4899">Entityâ†’Entity</div>
                        <div>MENTIONS</div><div style="color:#22c55e">Topicâ†’Entity</div>
                        <div>HAS_ENTITY</div><div style="color:#ec4899">Meetingâ†’Entity</div>
                    </div>
                    <div style="font-size:0.78em;font-weight:600;margin:10px 0 4px;">Statistics</div>
                    <div class="details-grid">
                        <div>Nodes</div><div id="stat-nodes">â€”</div>
                        <div>Edges</div><div id="stat-edges">â€”</div>
                        <div>Node Types</div><div>7</div>
                        <div>Rel Types</div><div>12</div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <div class="status-bar" id="status-bar">SpeakNode | Ready</div>
</div>

<script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<script>
// Node & Edge Style
const NODE_CFG = {
    Meeting:   {color:'#60a5fa', glow:'rgba(96,165,250,0.3)',  size:28, icon:'ğŸ“…'},
    Person:    {color:'#a855f7', glow:'rgba(168,85,247,0.3)',  size:20, icon:'ğŸ‘¤'},
    Topic:     {color:'#22c55e', glow:'rgba(34,197,94,0.3)',   size:18, icon:'ğŸ’¡'},
    Task:      {color:'#f59e0b', glow:'rgba(245,158,11,0.3)',  size:16, icon:'âœ…'},
    Decision:  {color:'#f472b6', glow:'rgba(244,114,182,0.3)', size:16, icon:'âš–ï¸'},
    Utterance: {color:'#06b6d4', glow:'rgba(6,182,212,0.2)',   size:10, icon:'ğŸ’¬'},
    Entity:    {color:'#ec4899', glow:'rgba(236,72,153,0.25)', size:14, icon:'ğŸ”—'}
};
const EDGE_CFG = {
    DISCUSSED:    {color:'rgba(96,165,250,0.5)',  w:2,   dash:false},
    PROPOSED:     {color:'rgba(168,85,247,0.5)',  w:2,   dash:false},
    ASSIGNED_TO:  {color:'rgba(245,158,11,0.5)',  w:2,   dash:[5,5]},
    RESULTED_IN:  {color:'rgba(244,114,182,0.5)', w:2,   dash:false},
    SPOKE:        {color:'rgba(6,182,212,0.3)',   w:1,   dash:false},
    CONTAINS:     {color:'rgba(96,165,250,0.2)',  w:1,   dash:[3,3]},
    HAS_TASK:     {color:'rgba(245,158,11,0.3)',  w:1.5, dash:false},
    HAS_DECISION: {color:'rgba(244,114,182,0.3)', w:1.5, dash:false},
    NEXT:         {color:'rgba(6,182,212,0.15)',  w:1,   dash:[2,4]},
    RELATED_TO:   {color:'rgba(236,72,153,0.35)', w:1.5, dash:[4,4]},
    MENTIONS:     {color:'rgba(34,197,94,0.3)',   w:1,   dash:[3,3]},
    HAS_ENTITY:   {color:'rgba(236,72,153,0.25)', w:1,   dash:false}
};

function mkNode(id, label, type, extra) {
    const c = NODE_CFG[type]; if (!c) return null;
    return {
        id, label: c.icon+' '+label, group:type,
        color:{background:c.glow, border:c.color, highlight:{background:c.color,border:'#fff'}, hover:{background:c.color,border:'#fff'}},
        borderWidth:1.5, borderWidthSelected:2.5,
        shadow:{enabled:true, color:c.glow, size:6, x:0, y:0},
        font:{color:'#e5e7eb', size:11, face:"'Segoe UI',sans-serif", strokeWidth:0},
        shape:'dot', size:c.size, _type:type, _extra:extra||{}
    };
}
function mkEdge(from, to, rel) {
    const c = EDGE_CFG[rel]||{color:'rgba(255,255,255,0.15)',w:1,dash:false};
    return {
        from, to, label:rel,
        color:{color:c.color, highlight:'#fff', hover:'#fff'},
        width:c.w, dashes:c.dash,
        font:{color:'rgba(255,255,255,0.2)', size:7, strokeWidth:0, align:'middle'},
        smooth:{type:'continuous', roundness:0.3},
        arrows:{to:{enabled:true, scaleFactor:0.35}},
        shadow:false
    };
}

// Scoped value decoder: "m_xxx::plain text" â†’ "plain text"
function dv(s) { if (!s) return ''; const i=String(s).indexOf('::'); return i>=0?s.slice(i+2):s; }

// Demo PNG paths (data is embedded in PNG metadata)
const DEMO_PATHS = [
    'demos/demo_weekly_meeting.png',
    'demos/demo_ai_seminar.png',
    'demos/demo_project_onboarding.png'
];

// State
let network = null;
let currentNodes = null;
let currentEdges = null;
let showUtterances = false;
let allNodeData = [];
let allEdgeData = [];

// Graph Dump â†’ vis-network rendering
function renderFromBundle(bundle) {
    const dump = bundle.graph_dump;
    const ar = bundle.analysis_result;
    const n = dump.nodes, e = dump.edges;

    allNodeData = []; allEdgeData = [];
    let idMap = {};  // for dedup

    // Meetings
    (n.meetings||[]).forEach(m => { if(!idMap[m.id]){idMap[m.id]=1; allNodeData.push(mkNode(m.id, m.title, 'Meeting', {date:m.date,source:m.source_file}));} });
    // People
    (n.people||[]).forEach(p => { const id='p_'+p.name; if(!idMap[id]){idMap[id]=1; allNodeData.push(mkNode(id, p.name, 'Person', {role:p.role}));} });
    // Topics
    (n.topics||[]).forEach(t => { const id='t_'+t.title; if(!idMap[id]){idMap[id]=1; allNodeData.push(mkNode(id, dv(t.title), 'Topic', {summary:t.summary}));} });
    // Tasks
    (n.tasks||[]).forEach(t => { const id='tk_'+t.description; if(!idMap[id]){idMap[id]=1; allNodeData.push(mkNode(id, dv(t.description), 'Task', {deadline:t.deadline,status:t.status}));} });
    // Decisions
    (n.decisions||[]).forEach(d => { const id='d_'+d.description; if(!idMap[id]){idMap[id]=1; allNodeData.push(mkNode(id, dv(d.description), 'Decision', {}));} });
    // Utterances
    (n.utterances||[]).forEach(u => { if(!idMap[u.id]){idMap[u.id]=1; allNodeData.push(mkNode(u.id, u.text.slice(0,25)+(u.text.length>25?'â€¦':''), 'Utterance', {text:u.text,start:u.start,end:u.end}));} });
    // Entities
    (n.entities||[]).forEach(en => { const id='e_'+en.name; if(!idMap[id]){idMap[id]=1; allNodeData.push(mkNode(id, dv(en.name), 'Entity', {entity_type:en.entity_type,description:en.description}));} });

    // Edges
    (e.discussed||[]).forEach(r => allEdgeData.push(mkEdge(r.meeting_id, 't_'+r.topic, 'DISCUSSED')));
    (e.proposed||[]).forEach(r => allEdgeData.push(mkEdge('p_'+r.person, 't_'+r.topic, 'PROPOSED')));
    (e.assigned_to||[]).forEach(r => allEdgeData.push(mkEdge('p_'+r.person, 'tk_'+r.task, 'ASSIGNED_TO')));
    (e.resulted_in||[]).forEach(r => allEdgeData.push(mkEdge('t_'+r.topic, 'd_'+r.decision, 'RESULTED_IN')));
    (e.spoke||[]).forEach(r => allEdgeData.push(mkEdge('p_'+r.person, r.utterance_id, 'SPOKE')));
    (e.next||[]).forEach(r => allEdgeData.push(mkEdge(r.from_utterance_id, r.to_utterance_id, 'NEXT')));
    (e.contains||[]).forEach(r => allEdgeData.push(mkEdge(r.meeting_id, r.utterance_id, 'CONTAINS')));
    (e.has_task||[]).forEach(r => allEdgeData.push(mkEdge(r.meeting_id, 'tk_'+r.task, 'HAS_TASK')));
    (e.has_decision||[]).forEach(r => allEdgeData.push(mkEdge(r.meeting_id, 'd_'+r.decision, 'HAS_DECISION')));
    (e.related_to||[]).forEach(r => allEdgeData.push(mkEdge('e_'+r.source, 'e_'+r.target, 'RELATED_TO')));
    (e.mentions||[]).forEach(r => allEdgeData.push(mkEdge('t_'+r.topic, 'e_'+r.entity, 'MENTIONS')));
    (e.has_entity||[]).forEach(r => allEdgeData.push(mkEdge(r.meeting_id, 'e_'+r.entity, 'HAS_ENTITY')));

    applyGraph();
    renderSummary(ar);
    document.getElementById('graphPlaceholder').style.display = 'none';
    document.getElementById('uttToggleWrap').style.display = 'flex';
}

function applyGraph() {
    const filteredNodes = showUtterances ? allNodeData : allNodeData.filter(n => n && n._type !== 'Utterance');
    const nodeIds = new Set(filteredNodes.map(n => n.id));
    const filteredEdges = allEdgeData.filter(e => e && nodeIds.has(e.from) && nodeIds.has(e.to));

    currentNodes = new vis.DataSet(filteredNodes.filter(Boolean));
    currentEdges = new vis.DataSet(filteredEdges.filter(Boolean));

    const container = document.getElementById('graph-canvas');
    if (network) { network.destroy(); network = null; }
    network = new vis.Network(container, {nodes:currentNodes, edges:currentEdges}, {
        physics: {
            solver:'forceAtlas2Based',
            forceAtlas2Based:{gravitationalConstant:-80, centralGravity:0.005, springLength:150, springConstant:0.04, damping:0.5},
            stabilization:{iterations:200, fit:true}
        },
        interaction:{hover:true, tooltipDelay:150, zoomView:true, dragView:true},
        edges:{selectionWidth:2},
        nodes:{chosen:{node:function(v){v.shadowSize=12;v.borderWidth=2.5;}}}
    });

    // Stats
    document.getElementById('stat-nodes').textContent = currentNodes.length;
    document.getElementById('stat-edges').textContent = currentEdges.length;
    document.getElementById('status-bar').textContent = 'SpeakNode | Nodes: '+currentNodes.length+' | Edges: '+currentEdges.length+' | Ready';

    // Click handler
    network.on('click', function(params) {
        const panel = document.getElementById('node-detail');
        if (!params.nodes.length) { panel.classList.remove('visible'); return; }
        const nd = currentNodes.get(params.nodes[0]);
        if (!nd) return;
        const cfg = NODE_CFG[nd._type];
        document.getElementById('detail-title').textContent = cfg.icon+' '+nd.label.replace(cfg.icon+' ','');
        document.getElementById('detail-title').style.color = cfg.color;
        let html = '<div class="field"><span class="field-label">Type</span><span style="color:'+cfg.color+'">'+nd._type+'</span></div>';
        const sc = {pending:'#f59e0b',in_progress:'#06b6d4',done:'#22c55e',blocked:'#ef4444'};
        for (const [k,v] of Object.entries(nd._extra||{})) {
            if (v===undefined||v===null||v==='') continue;
            let d = v;
            if (k==='status') d = '<span style="color:'+(sc[v]||'#e5e7eb')+'">'+v+'</span>';
            html += '<div class="field"><span class="field-label">'+k+'</span><span>'+d+'</span></div>';
        }
        html += '<div class="field"><span class="field-label">Connections</span><span>'+network.getConnectedNodes(params.nodes[0]).length+'</span></div>';
        document.getElementById('detail-fields').innerHTML = html;
        panel.classList.add('visible');
    });
    network.on('doubleClick', function(params) {
        if (params.nodes.length) network.focus(params.nodes[0], {scale:1.5, animation:{duration:500, easingFunction:'easeInOutQuad'}});
    });
}

// Summary rendering
function renderSummary(ar) {
    const c = document.getElementById('summaryContainer');
    let h = '';

    // Topics
    if (ar.topics && ar.topics.length) {
        h += '<div class="summary-section"><h3 style="color:#22c55e;">ğŸ’¡ Topics ('+ar.topics.length+')</h3>';
        ar.topics.forEach(t => {
            h += '<div class="summary-item topic"><b>'+t.title+'</b>';
            if (t.summary) h += '<br><span class="si-label">'+t.summary+'</span>';
            if (t.proposer && t.proposer!=='Unknown') h += '<br><span class="si-label">ì œì•ˆ: '+t.proposer+'</span>';
            h += '</div>';
        });
        h += '</div>';
    }

    // Decisions
    if (ar.decisions && ar.decisions.length) {
        h += '<div class="summary-section"><h3 style="color:#f472b6;">âš–ï¸ Decisions ('+ar.decisions.length+')</h3>';
        ar.decisions.forEach(d => {
            h += '<div class="summary-item decision">'+d.description+'</div>';
        });
        h += '</div>';
    }

    // Tasks
    if (ar.tasks && ar.tasks.length) {
        h += '<div class="summary-section"><h3 style="color:#f59e0b;">âœ… Tasks ('+ar.tasks.length+')</h3>';
        ar.tasks.forEach(t => {
            const st = t.status||'pending';
            h += '<div class="summary-item task">'+t.description+'<br>';
            h += '<span class="si-label">'+t.assignee+' Â· '+t.deadline+'</span> ';
            h += '<span class="task-status '+st+'">'+st+'</span></div>';
        });
        h += '</div>';
    }

    // People
    if (ar.people && ar.people.length) {
        h += '<div class="summary-section"><h3 style="color:#a855f7;">ğŸ‘¤ People ('+ar.people.length+')</h3>';
        ar.people.forEach(p => {
            h += '<div class="summary-item person">'+p.name+' <span class="si-label">'+p.role+'</span></div>';
        });
        h += '</div>';
    }

    // Entities
    if (ar.entities && ar.entities.length) {
        h += '<div class="summary-section"><h3 style="color:#ec4899;">ğŸ”— Entities ('+ar.entities.length+')</h3>';
        const groups = {};
        ar.entities.forEach(e => { (groups[e.entity_type]||(groups[e.entity_type]=[])).push(e); });
        for (const [type, items] of Object.entries(groups)) {
            h += '<div style="font-size:0.72em;color:#6b7280;margin:4px 0 2px;text-transform:uppercase;">'+type+'</div>';
            items.forEach(e => {
                h += '<div class="summary-item entity">'+e.name;
                if (e.description) h += ' <span class="si-label">â€” '+e.description+'</span>';
                h += '</div>';
            });
        }
        h += '</div>';
    }

    // Relations
    if (ar.relations && ar.relations.length) {
        h += '<div class="summary-section"><h3 style="color:#ec4899;">â†” Relations ('+ar.relations.length+')</h3>';
        ar.relations.forEach(r => {
            h += '<div class="summary-item entity" style="font-size:0.75em;">'+r.source+' <span style="color:#ec4899;">â€”['+r.relation_type+']â†’</span> '+r.target+'</div>';
        });
        h += '</div>';
    }

    if (!h) h = '<div class="summary-placeholder"><p>ë°ì´í„° ì—†ìŒ</p></div>';
    c.innerHTML = h;
}

// Demo loader â€” fetch PNG â†’ parse metadata â†’ render
const _demoCache = {};  // idx â†’ parsed bundle (avoid re-fetch)

function loadDemo(idx) {
    document.querySelectorAll('.demo-img-card').forEach(c => c.classList.remove('active'));
    document.getElementById('dc'+idx).classList.add('active');

    if (_demoCache[idx]) {
        renderFromBundle(_demoCache[idx]);
        return;
    }

    document.getElementById('status-bar').textContent = 'SpeakNode | Loading demoâ€¦';

    fetch(DEMO_PATHS[idx])
        .then(r => { if (!r.ok) throw new Error('Fetch failed: '+r.status); return r.arrayBuffer(); })
        .then(buf => {
            const chunks = parsePngTextChunks(buf);
            const encoded = chunks['speaknode_data_zlib_b64'];
            if (!encoded) throw new Error('No SpeakNode data in PNG');
            const compressed = Uint8Array.from(atob(encoded), c => c.charCodeAt(0));
            const decompressed = pako.inflate(compressed);
            const jsonStr = new TextDecoder().decode(decompressed);
            const data = JSON.parse(jsonStr);

            let bundle;
            if (data.format === 'speaknode_graph_bundle_v1') {
                bundle = {
                    analysis_result: data.analysis_result || {},
                    graph_dump: data.graph_dump || { schema_version:3, nodes:{}, edges:{} },
                    meta: { title:'Demo', icon:'ğŸ“', desc:'' }
                };
            } else {
                bundle = {
                    analysis_result: data,
                    graph_dump: { schema_version:3, nodes:{}, edges:{} },
                    meta: { title:'Demo (Legacy)', icon:'ğŸ“', desc:'' }
                };
            }
            _demoCache[idx] = bundle;
            renderFromBundle(bundle);
            document.getElementById('status-bar').textContent = 'SpeakNode | Demo loaded';
        })
        .catch(err => {
            console.error('Demo load error:', err);
            document.getElementById('status-bar').textContent = 'SpeakNode | Demo load failed: '+err.message;
        });
}

// Utterance toggle
document.getElementById('uttToggle').addEventListener('change', function() {
    showUtterances = this.checked;
    if (allNodeData.length) applyGraph();
});

// PNG Upload â€” parse tEXt chunk for speaknode_data_zlib_b64
function parsePngTextChunks(buf) {
    const view = new DataView(buf);
    // Check PNG magic
    if (view.getUint32(0) !== 0x89504E47) throw new Error('Not a valid PNG file');
    let offset = 8;
    const chunks = {};
    while (offset < buf.byteLength) {
        const len = view.getUint32(offset);
        const typeBytes = new Uint8Array(buf, offset+4, 4);
        const type = String.fromCharCode(...typeBytes);
        if (type === 'tEXt') {
            const data = new Uint8Array(buf, offset+8, len);
            const nullIdx = data.indexOf(0);
            if (nullIdx > 0) {
                const key = new TextDecoder().decode(data.slice(0, nullIdx));
                const val = new TextDecoder().decode(data.slice(nullIdx+1));
                chunks[key] = val;
            }
        }
        if (type === 'IEND') break;
        offset += 12 + len; // 4 len + 4 type + len data + 4 crc
    }
    return chunks;
}

function handlePngUpload(file) {
    if (!file || !file.name.toLowerCase().endsWith('.png')) {
        alert('PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const chunks = parsePngTextChunks(ev.target.result);
            const encoded = chunks['speaknode_data_zlib_b64'];
            if (!encoded) {
                // Try legacy key
                const legacy = chunks['speaknode_data'];
                if (legacy) {
                    const data = JSON.parse(legacy);
                    handleParsedData(data);
                    return;
                }
                alert('ì´ PNGì— SpeakNode ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nSpeakNode ì•±ì—ì„œ ë‚´ë³´ë‚¸ PNGë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            const compressed = Uint8Array.from(atob(encoded), c => c.charCodeAt(0));
            const decompressed = pako.inflate(compressed);
            const jsonStr = new TextDecoder().decode(decompressed);
            const data = JSON.parse(jsonStr);
            handleParsedData(data);
        } catch (err) {
            alert('PNG íŒŒì‹± ì˜¤ë¥˜: ' + err.message);
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

function handleParsedData(data) {
    let bundle;
    if (data.format === 'speaknode_graph_bundle_v1') {
        bundle = {
            analysis_result: data.analysis_result || {},
            graph_dump: data.graph_dump || { schema_version:3, nodes:{}, edges:{} },
            meta: { title:'Uploaded PNG', icon:'ğŸ“', desc:'ì‚¬ìš©ì ì—…ë¡œë“œ ë°ì´í„°' }
        };
    } else {
        // Legacy: data is analysis_result directly
        bundle = {
            analysis_result: data,
            graph_dump: { schema_version:3, nodes:{}, edges:{} },
            meta: { title:'Uploaded PNG (Legacy)', icon:'ğŸ“', desc:'ë ˆê±°ì‹œ í¬ë§·' }
        };
    }
    document.querySelectorAll('.demo-card').forEach(c => c.classList.remove('active'));
    renderFromBundle(bundle);
    document.getElementById('status-bar').textContent = 'SpeakNode | PNG loaded successfully';
}

// â”€â”€ Drop zone & File input â”€â”€
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', ev => { ev.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', ev => { ev.preventDefault(); dropZone.classList.remove('dragover'); if(ev.dataTransfer.files.length) handlePngUpload(ev.dataTransfer.files[0]); });
fileInput.addEventListener('change', ev => { if(ev.target.files.length) handlePngUpload(ev.target.files[0]); });

</script>
</body>
</html>
